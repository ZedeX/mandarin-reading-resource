<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å°å­¦è¯­æ–‡ç¤ºèŒƒè¯µè¯»åº“</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box {
            flex: 2;
            min-width: 250px;
        }

        .audio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .audio-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .audio-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 15px;
        }

        .card-body {
            padding: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .grade, .term {
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .grade {
            background: #ffeaa7;
        }

        .term {
            background: #fd79a8;
            color: white;
        }

        .playback-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .playback-info.completed {
            color: #00b894;
            font-weight: bold;
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            background-color: #74b9ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            align-self: center;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }

        .error {
            color: red;
            text-align: center;
            padding: 20px;
            font-weight: bold;
        }

        .server-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;

            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰åœ¨åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤º */
        }

        .file-upload {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload input {
            margin: 10px;
        }

        .file-upload button {
            background: #74b9ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .file-upload button:hover {
            background: #0984e3;
        }

        /* è‡ªå®šä¹‰éŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ */
        .custom-audio-player {
            display: flex;
            align-items: center;
            background: #f0f8ff;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .play-btn {
            background: #74b9ff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        .play-btn:hover {
            background: #0984e3;
        }

        .progress-container {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #74b9ff;
            border-radius: 3px;
            width: 0%;
        }

        .time-display {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
            min-width: 80px;
            text-align: center;
        }

        .audio-player {
            display: none;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .audio-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ä¸­å°å­¦è¯­æ–‡ç¤ºèŒƒè¯µè¯»åº“</h1>
        <p>ä¼˜è´¨çš„è¯­æ–‡è¯¾æ–‡æœ—è¯»èµ„æº</p>
    </header>

    <div class="container">
        <div class="server-info">
            <p><strong>ä½¿ç”¨è¯´æ˜:</strong> æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»»ä¸€æ–¹å¼åŠ è½½æ•°æ®:</p>
            <p>1. ä½¿ç”¨ Python å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨: <code>python server.py</code>ï¼Œç„¶åè®¿é—®: <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></p>
            <p>2. ç›´æ¥æ‰“å¼€æ­¤HTMLæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å°è¯•åŠ è½½æ•°æ®</p>
        </div>

        <div class="file-upload" id="fileUploadSection" style="display: none;">
            <h3>æœ¬åœ°åŠ è½½æ•°æ®</h3>
            <p>è¯·é€‰æ‹©[list.json](list.json)æ–‡ä»¶ä»¥åŠ è½½æ•°æ®</p>
            <input type="file" id="jsonFile" accept=".json">
            <button onclick="loadLocalJson()">åŠ è½½æ•°æ®</button>
        </div>

        <div class="stats">
            å…±æœ‰ <span id="total-count">0</span> ä¸ªæœ—è¯»èµ„æº
        </div>

        <div class="controls">
            <div class="filter-group">
                <label for="grade-filter">å¹´çº§</label>
                <select id="grade-filter">
                    <option value="">å…¨éƒ¨å¹´çº§</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="term-filter">å­¦æœŸ</label>
                <select id="term-filter">
                    <option value="">å…¨éƒ¨å­¦æœŸ</option>
                    <option value="1">ç¬¬ä¸€å­¦æœŸ</option>
                    <option value="2">ç¬¬äºŒå­¦æœŸ</option>
                </select>
            </div>

            <div class="filter-group search-box">
                <label for="search-input">æœç´¢è¯¾æ–‡</label>
                <input type="text" id="search-input" placeholder="è¾“å…¥è¯¾æ–‡æ ‡é¢˜...">
            </div>
        </div>

        <div class="audio-grid" id="audio-container">
            <!-- éŸ³é¢‘å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="pagination" id="pagination">
            <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å­˜å‚¨æ‰€æœ‰éŸ³é¢‘æ•°æ®
        let audioData = [];
        // å­˜å‚¨è¿‡æ»¤åçš„æ•°æ®
        let filteredData = [];
        // å½“å‰é¡µç 
        let currentPage = 1;
        // æ¯é¡µæ˜¾ç¤ºçš„é¡¹ç›®æ•°
        const itemsPerPage = 15;
        // æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®
        let isLoading = false;
        // å½“å‰æ’­æ”¾çš„éŸ³é¢‘å…ƒç´ 
        let currentlyPlaying = null;
        // å½“å‰æ’­æ”¾çš„æŒ‰é’®
        let currentPlayButton = null;
        // å½“å‰ç„¦ç‚¹æ’­æ”¾å™¨ï¼ˆç”¨äºé”®ç›˜æ§åˆ¶ï¼‰
        let focusedPlayer = null;
        // æ’­æ”¾çŠ¶æ€å­˜å‚¨é”®åå‰ç¼€
        const PLAYBACK_STORAGE_KEY = 'audio_playback_status_';
        // ç”¨æˆ·çŠ¶æ€å­˜å‚¨é”®å
        const USER_STATE_KEY = 'user_state';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å°è¯•å¤šç§æ–¹å¼åŠ è½½æ•°æ®
            loadAudioData();
        });

        // ä»å¤šç§æ¥æºåŠ è½½JSONæ•°æ®
        function loadAudioData() {
            // é¦–å…ˆå°è¯•é€šè¿‡fetchåŠ è½½ï¼ˆæœåŠ¡å™¨æ–¹å¼ï¼‰
            fetch('list.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    handleDataLoadSuccess(data);
                    // æ¢å¤ç”¨æˆ·çŠ¶æ€
                    restoreUserState();
                })
                .catch(error => {
                    console.error('é€šè¿‡æœåŠ¡å™¨åŠ è½½æ•°æ®æ—¶å‡ºé”™:', error);
                    // å¦‚æœfetchå¤±è´¥ï¼Œå°è¯•é€šè¿‡XMLHttpRequeståŠ è½½
                    loadViaXMLHttpRequest();
                });
        }

        // é€šè¿‡XMLHttpRequeståŠ è½½æ•°æ®
        function loadViaXMLHttpRequest() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'list.json', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            handleDataLoadSuccess(data);
                            // æ¢å¤ç”¨æˆ·çŠ¶æ€
                            restoreUserState();
                        } catch (e) {
                            console.error('è§£æJSONæ•°æ®æ—¶å‡ºé”™:', e);
                            showFileUploadSection();
                        }
                    } else {
                        console.error('é€šè¿‡XMLHttpRequeståŠ è½½æ•°æ®å¤±è´¥ï¼ŒçŠ¶æ€ç :', xhr.status);
                        showFileUploadSection();
                    }
                }
            };
            xhr.onerror = function() {
                console.error('é€šè¿‡XMLHttpRequeståŠ è½½æ•°æ®æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
                showFileUploadSection();
            };
            xhr.send();
        }

        // å¤„ç†æ•°æ®åŠ è½½æˆåŠŸ
        function handleDataLoadSuccess(data) {
            // éªŒè¯æ•°æ®æ ¼å¼
            if (!Array.isArray(data)) {
                throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„');
            }
            
            audioData = data;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('total-count').textContent = audioData.length;
            
            // å¡«å……å¹´çº§ç­›é€‰é€‰é¡¹
            populateGradeFilter();
            
            // æ˜¾ç¤ºæ‰€æœ‰éŸ³é¢‘
            filteredData = [...audioData];
            renderPage(currentPage);
            
            // ç»‘å®šç­›é€‰äº‹ä»¶
            bindFilterEvents();
            
            // éšè—æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            document.getElementById('fileUploadSection').style.display = 'none';
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
        function showFileUploadSection() {
            document.getElementById('fileUploadSection').style.display = 'block';
        }

        // ä»æœ¬åœ°æ–‡ä»¶åŠ è½½JSONæ•°æ®
        function loadLocalJson() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªJSONæ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    handleDataLoadSuccess(data);
                    // æ¢å¤ç”¨æˆ·çŠ¶æ€
                    restoreUserState();
                    // éšè—æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                    document.getElementById('fileUploadSection').style.display = 'none';
                } catch (e) {
                    console.error('è§£æJSONæ–‡ä»¶æ—¶å‡ºé”™:', e);
                    alert('è§£æJSONæ–‡ä»¶æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.onerror = function() {
                console.error('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™');
                alert('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™');
            };
            reader.readAsText(file, 'utf-8');
        }

        // å¡«å……å¹´çº§ç­›é€‰é€‰é¡¹
        function populateGradeFilter() {
            const gradeFilter = document.getElementById('grade-filter');
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            gradeFilter.innerHTML = '<option value="">å…¨éƒ¨å¹´çº§</option>';
            
            // ç¡®ä¿æ•°æ®ä¸­æœ‰å¹´çº§å­—æ®µ
            if (audioData.length > 0 && audioData[0].å¹´çº§) {
                const grades = [...new Set(audioData.map(item => item.å¹´çº§))].sort();
                
                grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = `${grade}å¹´çº§`;
                    gradeFilter.appendChild(option);
                });
            }
        }

        // ç»‘å®šç­›é€‰äº‹ä»¶
        function bindFilterEvents() {
            document.getElementById('grade-filter').addEventListener('change', handleFilterChange);
            document.getElementById('term-filter').addEventListener('change', handleFilterChange);
            document.getElementById('search-input').addEventListener('input', debounce(handleFilterChange, 300));
        }

        // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è§¦å‘ç­›é€‰
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // å¤„ç†ç­›é€‰å˜åŒ–
        function handleFilterChange() {
            currentPage = 1;
            filterAudio();
            // ä¿å­˜ç”¨æˆ·çŠ¶æ€
            saveUserState();
        }

        // ç­›é€‰éŸ³é¢‘
        function filterAudio() {
            const gradeFilter = document.getElementById('grade-filter').value;
            const termFilter = document.getElementById('term-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            // ç¡®ä¿æ•°æ®å­˜åœ¨
            if (!audioData || audioData.length === 0) {
                filteredData = [];
                renderPage(currentPage);
                return;
            }
            
            filteredData = audioData.filter(item => {
                // æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦çš„å±æ€§
                if (!item.å¹´çº§ || !item.å­¦æœŸ || !item.è¯¾æ–‡æ ‡é¢˜) {
                    return false;
                }
                
                // å¹´çº§ç­›é€‰
                if (gradeFilter && item.å¹´çº§ !== gradeFilter) {
                    return false;
                }
                
                // å­¦æœŸç­›é€‰
                if (termFilter && item.å­¦æœŸ !== termFilter) {
                    return false;
                }
                
                // æœç´¢ç­›é€‰
                if (searchInput && !item.è¯¾æ–‡æ ‡é¢˜.toLowerCase().includes(searchInput)) {
                    return false;
                }
                
                return true;
            });
            
            renderPage(currentPage);
        }

        // æ¸²æŸ“æŒ‡å®šé¡µé¢
        function renderPage(page) {
            if (isLoading) return;
            
            const container = document.getElementById('audio-container');
            const pagination = document.getElementById('pagination');
            
            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            // å¦‚æœæ²¡æœ‰æ•°æ®
            if (!filteredData || filteredData.length === 0) {
                container.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„è¯¾æ–‡æœ—è¯»èµ„æº</div>';
                pagination.innerHTML = '';
                return;
            }
            
            // è®¡ç®—åˆ†é¡µæ•°æ®
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½ï¼Œé¿å…é˜»å¡UI
            setTimeout(() => {
                if (pageData.length === 0) {
                    container.innerHTML = '<div class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„è¯¾æ–‡æœ—è¯»èµ„æº</div>';
                } else {
                    container.innerHTML = pageData.map((item, index) => {
                        // ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨
                        const src = item.src || '';
                        const grade = item.å¹´çº§ || '';
                        const term = item.å­¦æœŸ || '';
                        const lessonNumber = item.è¯¾æ–‡åºå· || '';
                        const title = item.è¯¾æ–‡æ ‡é¢˜ || '';
                        // ä¸ºæ¯ä¸ªæ’­æ”¾å™¨ç”Ÿæˆå”¯ä¸€ID
                        const playerId = `player-${(page - 1) * itemsPerPage + index}`;
                        const buttonId = `btn-${(page - 1) * itemsPerPage + index}`;
                        const progressId = `progress-${(page - 1) * itemsPerPage + index}`;
                        const timeId = `time-${(page - 1) * itemsPerPage + index}`;
                        const playbackInfoId = `playback-info-${(page - 1) * itemsPerPage + index}`;
                        
                        // è·å–æ’­æ”¾çŠ¶æ€ä¿¡æ¯
                        const playbackStatus = getPlaybackStatus(src);
                        let playbackInfoText = '';
                        if (playbackStatus) {
                            if (playbackStatus.completed) {
                                playbackInfoText = `å·²å®Œæˆæ’­æ”¾${playbackStatus.playCount}æ¬¡ï¼Œä¸Šæ¬¡æ’­æ”¾åˆ°${formatTime(playbackStatus.currentTime)}`;
                            } else {
                                playbackInfoText = `ä¸Šæ¬¡æ’­æ”¾åˆ°${formatTime(playbackStatus.currentTime)}ï¼Œå·²æ’­æ”¾${Math.round((playbackStatus.currentTime / playbackStatus.duration) * 100)}%`;
                            }
                        }
                        
                        return `
                        <div class="audio-card">
                            <div class="card-header">
                                <div class="card-title">${title}</div>
                            </div>
                            <div class="card-body">
                                <div class="card-info">
                                    <span class="grade">${grade}å¹´çº§</span>
                                    <span class="term">ç¬¬${term}å­¦æœŸ</span>
                                </div>
                                <div class="card-info">
                                    <span>${lessonNumber}</span>
                                </div>
                                <div class="custom-audio-player">
                                    <button id="${buttonId}" class="play-btn">â–¶</button>
                                    <div id="${progressId}" class="progress-container">
                                        <div class="progress-bar"></div>
                                    </div>
                                    <div id="${timeId}" class="time-display">00:00 / 00:00</div>
                                    <audio id="${playerId}" class="audio-player" preload="none">
                                        <source src="${src}" type="audio/ogg">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                                    </audio>
                                </div>
                                <div id="${playbackInfoId}" class="playback-info ${playbackStatus && playbackStatus.completed ? 'completed' : ''}">
                                    ${playbackInfoText}
                                </div>
                            </div>
                        </div>
                    `}).join('');
                    
                    // åˆå§‹åŒ–æ‰€æœ‰æ’­æ”¾å™¨
                    initializePlayers();
                }
                
                // æ¸²æŸ“åˆ†é¡µæ§ä»¶
                renderPagination(page, totalPages);
                
                // ä¿å­˜ç”¨æˆ·çŠ¶æ€
                saveUserState();
            }, 0);
        }

        // åˆå§‹åŒ–æ’­æ”¾å™¨
        function initializePlayers() {
            const players = document.querySelectorAll('.audio-player');
            players.forEach((player, index) => {
                const playerId = player.id;
                const buttonId = playerId.replace('player-', 'btn-');
                const progressId = playerId.replace('player-', 'progress-');
                const timeId = playerId.replace('player-', 'time-');
                const playbackInfoId = playerId.replace('player-', 'playback-info-');
                
                const playButton = document.getElementById(buttonId);
                const progressBar = document.getElementById(progressId).querySelector('.progress-bar');
                const progressContainer = document.getElementById(progressId);
                const timeDisplay = document.getElementById(timeId);
                const playbackInfo = document.getElementById(playbackInfoId);
                
                // è·å–éŸ³é¢‘æºè·¯å¾„
                const audioSrc = filteredData[(currentPage - 1) * itemsPerPage + index].src || '';
                
                // æ ‡è®°æ˜¯å¦å·²åŠ è½½éŸ³é¢‘æº
                let isSourceLoaded = false;
                
                // ç›‘å¬æ’­æ”¾æŒ‰é’®ç‚¹å‡»
                playButton.addEventListener('click', function() {
                    // å¦‚æœå°šæœªåŠ è½½éŸ³é¢‘æºï¼Œåˆ™åŠ è½½
                    if (!isSourceLoaded) {
                        const source = document.createElement('source');
                        source.src = audioSrc;
                        source.type = 'audio/ogg';
                        player.appendChild(source);
                        isSourceLoaded = true;
                    }
                    
                    togglePlay(player, playButton, playbackInfo);
                });
                
                // ç›‘å¬æ’­æ”¾è¿›åº¦
                player.addEventListener('timeupdate', function() {
                    updateProgress(player, progressBar, timeDisplay);
                    // æ¯éš”5ç§’ä¿å­˜ä¸€æ¬¡æ’­æ”¾çŠ¶æ€
                    if (Math.floor(player.currentTime) % 5 === 0) {
                        savePlaybackStatus(player);
                    }
                });
                
                // ç›‘å¬è¿›åº¦æ¡ç‚¹å‡»
                progressContainer.addEventListener('click', function(e) {
                    // å¦‚æœå°šæœªåŠ è½½éŸ³é¢‘æºï¼Œåˆ™åŠ è½½
                    if (!isSourceLoaded) {
                        const source = document.createElement('source');
                        source.src = audioSrc;
                        source.type = 'audio/ogg';
                        player.appendChild(source);
                        isSourceLoaded = true;
                    }
                    
                    setProgress(player, progressContainer, e);
                });
                
                // ç›‘å¬æ’­æ”¾å®Œæˆ
                player.addEventListener('ended', function() {
                    playButton.textContent = 'â–¶';
                    playButton.style.background = '#74b9ff';
                    if (currentlyPlaying === player) {
                        currentlyPlaying = null;
                        currentPlayButton = null;
                        focusedPlayer = null;
                    }
                    // ä¿å­˜æ’­æ”¾å®ŒæˆçŠ¶æ€
                    savePlaybackStatus(player, true);
                    // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
                    updatePlaybackInfo(playbackInfo, player);
                });
                
                // ç›‘å¬åŠ è½½å…ƒæ•°æ®
                player.addEventListener('loadedmetadata', function() {
                    updateTimeDisplay(player, timeDisplay);
                    // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
                    updatePlaybackInfo(playbackInfo, player);
                });
                
                // ç›‘å¬æ’­æ”¾å¼€å§‹
                player.addEventListener('play', function() {
                    // ç¡®ä¿åœ¨æ’­æ”¾å¼€å§‹æ—¶æ›´æ–°æ—¶é—´æ˜¾ç¤º
                    updateTimeDisplay(player, timeDisplay);
                    updatePlaybackInfo(playbackInfo, player);
                });
                
                // ç›‘å¬æš‚åœ
                player.addEventListener('pause', function() {
                    updateTimeDisplay(player, timeDisplay);
                    savePlaybackStatus(player);
                    updatePlaybackInfo(playbackInfo, player);
                });
                
                // ç›‘å¬æ’­æ”¾é”™è¯¯
                player.addEventListener('error', function(e) {
                    console.error('éŸ³é¢‘æ’­æ”¾å‡ºé”™:', e);
                    updateTimeDisplay(player, timeDisplay);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    if (timeDisplay) {
                        timeDisplay.textContent = '00:00 / 00:00';
                    }
                });
                
                // è·å–æ’­æ”¾çŠ¶æ€
                const playbackStatus = getPlaybackStatus(audioSrc);
                
                // å¦‚æœæœ‰ä¿å­˜çš„æ’­æ”¾ä½ç½®ï¼Œè®¾ç½®åˆ°è¯¥ä½ç½®
                if (playbackStatus && playbackStatus.currentTime > 0) {
                    // åªæœ‰åœ¨å…ƒæ•°æ®åŠ è½½å®Œæˆåæ‰è®¾ç½®æ’­æ”¾ä½ç½®
                    player.addEventListener('loadedmetadata', function() {
                        player.currentTime = playbackStatus.currentTime || 0;
                        updateTimeDisplay(player, timeDisplay);
                    });
                } else {
                    // ç«‹å³æ›´æ–°æ—¶é—´æ˜¾ç¤º
                    updateTimeDisplay(player, timeDisplay);
                }
                
                // åˆå§‹åŒ–æ’­æ”¾å™¨å¯¹è±¡
                player.player = {
                    player: player,
                    button: playButton,
                    playbackInfo: playbackInfo
                };
            });
        }

        // åˆ‡æ¢æ’­æ”¾çŠ¶æ€
        function togglePlay(player, playButton, playbackInfo) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œåˆ™æš‚åœ
            if (currentlyPlaying === player && !player.paused) {
                player.pause();
                playButton.textContent = 'â–¶';
                playButton.style.background = '#74b9ff';
                currentlyPlaying = null;
                currentPlayButton = null;
                if (focusedPlayer && focusedPlayer.player === player) {
                    focusedPlayer = null;
                }
                // ä¿å­˜æ’­æ”¾çŠ¶æ€
                savePlaybackStatus(player);
                // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
                updatePlaybackInfo(playbackInfo, player);
                return;
            }
            
            // å¦‚æœæœ‰å…¶ä»–éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œå…ˆæš‚åœå®ƒ
            if (currentlyPlaying) {
                currentlyPlaying.pause();
                if (currentPlayButton) {
                    currentPlayButton.textContent = 'â–¶';
                    currentPlayButton.style.background = '#74b9ff';
                }
                // ä¿å­˜ä¹‹å‰æ’­æ”¾çš„éŸ³é¢‘çŠ¶æ€
                savePlaybackStatus(currentlyPlaying);
                updatePlaybackInfo(currentlyPlaying.player.playbackInfo, currentlyPlaying);
            }
            
            // æ’­æ”¾å½“å‰éŸ³é¢‘
            player.play().catch(e => {
                console.error('æ’­æ”¾å¤±è´¥:', e);
                alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
            playButton.textContent = 'âšâš';
            playButton.style.background = '#0984e3';
            
            // æ›´æ–°å½“å‰æ’­æ”¾çš„éŸ³é¢‘å’ŒæŒ‰é’®
            currentlyPlaying = player;
            currentPlayButton = playButton;
            focusedPlayer = {
                player: player,
                button: playButton
            };
            
            // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
            updatePlaybackInfo(playbackInfo, player);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(player, progressBar, timeDisplay) {
            updateTimeDisplay(player, timeDisplay);
            
            // ç¡®ä¿åœ¨æœ‰æ•ˆçš„æ•°å€¼ä¸‹æ›´æ–°è¿›åº¦æ¡
            if (player.duration && isFinite(player.duration) && player.duration > 0) {
                const percent = (player.currentTime / player.duration) * 100;
                // é™åˆ¶ç™¾åˆ†æ¯”åœ¨0-100ä¹‹é—´
                const clampedPercent = Math.min(100, Math.max(0, percent));
                progressBar.style.width = `${clampedPercent}%`;
            } else {
                // å¦‚æœæ—¶é•¿æ— æ•ˆï¼Œé‡ç½®è¿›åº¦æ¡
                progressBar.style.width = '0%';
            }
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay(player, timeDisplay) {
            const current = formatTime(player.currentTime);
            // ç¡®ä¿åœ¨éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåå†è·å–æ—¶é•¿
            let duration = '00:00';
            if (player.duration && isFinite(player.duration)) {
                duration = formatTime(player.duration);
            }
            timeDisplay.textContent = `${current} / ${duration}`;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            // å¤„ç†æ— æ•ˆçš„æ—¶é—´å€¼
            if (isNaN(seconds) || !isFinite(seconds) || seconds < 0) {
                return '00:00';
            }
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // è®¾ç½®è¿›åº¦
        function setProgress(player, progressContainer, e) {
            // å¦‚æœæ²¡æœ‰éŸ³é¢‘æºï¼Œåˆ™ä¸æ‰§è¡Œæ“ä½œ
            if (!player.querySelector('source')) {
                return;
            }
            
            const width = progressContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = player.duration;
            
            player.currentTime = (clickX / width) * duration;
            // ä¿å­˜æ’­æ”¾çŠ¶æ€
            savePlaybackStatus(player);
        }

        // ä¿å­˜æ’­æ”¾çŠ¶æ€åˆ°localStorage
        function savePlaybackStatus(player, isCompleted = false) {
            try {
                // è·å–éŸ³é¢‘æºè·¯å¾„
                let src = '';
                if (player.querySelector('source')) {
                    src = player.querySelector('source').src;
                } else {
                    // å¦‚æœsourceå…ƒç´ ä¸å­˜åœ¨ï¼Œä»filteredDataä¸­è·å–
                    const playerId = player.id;
                    const playerIndex = parseInt(playerId.replace('player-', ''));
                    const dataIndex = (currentPage - 1) * itemsPerPage + playerIndex;
                    if (filteredData[dataIndex] && filteredData[dataIndex].src) {
                        src = filteredData[dataIndex].src;
                    }
                }
                
                const currentTime = player.currentTime;
                const duration = player.duration || 0;
                
                // è·å–ç°æœ‰çš„æ’­æ”¾çŠ¶æ€
                let playbackStatus = getPlaybackStatus(src) || {
                    playCount: 0,
                    completed: false,
                    currentTime: 0,
                    duration: duration
                };
                
                // æ›´æ–°æ’­æ”¾çŠ¶æ€
                playbackStatus.currentTime = currentTime;
                playbackStatus.duration = duration;
                
                // å¦‚æœæ ‡è®°ä¸ºå®Œæˆï¼Œå¢åŠ æ’­æ”¾æ¬¡æ•°
                if (isCompleted) {
                    playbackStatus.playCount = (playbackStatus.playCount || 0) + 1;
                    playbackStatus.completed = true;
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem(PLAYBACK_STORAGE_KEY + src, JSON.stringify(playbackStatus));
            } catch (e) {
                console.error('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:', e);
            }
        }

        // è·å–æ’­æ”¾çŠ¶æ€
        function getPlaybackStatus(src) {
            try {
                const stored = localStorage.getItem(PLAYBACK_STORAGE_KEY + src);
                return stored ? JSON.parse(stored) : null;
            } catch (e) {
                console.error('è·å–æ’­æ”¾çŠ¶æ€å¤±è´¥:', e);
                return null;
            }
        }

        // æ›´æ–°æ’­æ”¾ä¿¡æ¯æ˜¾ç¤º
        function updatePlaybackInfo(playbackInfoElement, player) {
            if (!playbackInfoElement) return;
            
            // è·å–éŸ³é¢‘æºè·¯å¾„
            let src = '';
            if (player.querySelector('source')) {
                src = player.querySelector('source').src;
            } else {
                // å¦‚æœsourceå…ƒç´ ä¸å­˜åœ¨ï¼Œä»filteredDataä¸­è·å–
                const playerId = player.id;
                const playerIndex = parseInt(playerId.replace('player-', ''));
                const dataIndex = (currentPage - 1) * itemsPerPage + playerIndex;
                if (filteredData[dataIndex] && filteredData[dataIndex].src) {
                    src = filteredData[dataIndex].src;
                }
            }
            
            const playbackStatus = getPlaybackStatus(src);
            
            if (playbackStatus) {
                // ç¡®ä¿æ—¶é—´å€¼æœ‰æ•ˆ
                const currentTime = playbackStatus.currentTime || 0;
                const duration = playbackStatus.duration || player.duration || 0;
                
                if (playbackStatus.completed) {
                    playbackInfoElement.textContent = `å·²å®Œæˆæ’­æ”¾${playbackStatus.playCount}æ¬¡ï¼Œä¸Šæ¬¡æ’­æ”¾åˆ°${formatTime(currentTime)}`;
                    playbackInfoElement.className = 'playback-info completed';
                } else {
                    // ç¡®ä¿è®¡ç®—ç™¾åˆ†æ¯”æ—¶ä¸ä¼šå‡ºç°é™¤é›¶é”™è¯¯
                    const percent = duration > 0 ? Math.round((currentTime / duration) * 100) : 0;
                    playbackInfoElement.textContent = `ä¸Šæ¬¡æ’­æ”¾åˆ°${formatTime(currentTime)}ï¼Œå·²æ’­æ”¾${percent}%`;
                    playbackInfoElement.className = 'playback-info';
                }
            } else {
                playbackInfoElement.textContent = '';
                playbackInfoElement.className = 'playback-info';
            }
        }

        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é¡µ
                </button>
            `;
            
            // é¡µç 
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button onclick="changePage(${i})" disabled style="background-color: #0984e3;">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span>...</span>`;
                }
                paginationHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é¡µ
                </button>
            `;
            
            // å½“å‰é¡µä¿¡æ¯
            paginationHTML += `<span>ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>`;
            
            pagination.innerHTML = paginationHTML;
            
            // ä¿å­˜ç”¨æˆ·çŠ¶æ€
            saveUserState();
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            // ç¡®ä¿é¡µç åœ¨æœ‰æ•ˆèŒƒå›´å†…
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages || page === currentPage) {
                return;
            }
            
            currentPage = page;
            renderPage(currentPage);
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // ä¿å­˜ç”¨æˆ·çŠ¶æ€
            saveUserState();
        }
            // ä¿å­˜ç”¨æˆ·çŠ¶æ€åˆ°localStorage
            function saveUserState() {
                const state = {
                    gradeFilter: document.getElementById('grade-filter').value,
                    termFilter: document.getElementById('term-filter').value,
                    searchInput: document.getElementById('search-input').value,
                    currentPage: currentPage
                };
                
                try {
                    localStorage.setItem(USER_STATE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error('ä¿å­˜ç”¨æˆ·çŠ¶æ€å¤±è´¥:', e);
                }
            }
        
            // ä»localStorageæ¢å¤ç”¨æˆ·çŠ¶æ€
            function restoreUserState() {
                try {
                    const savedState = localStorage.getItem(USER_STATE_KEY);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        
                        // æ¢å¤ç­›é€‰æ¡ä»¶
                        if (state.gradeFilter) {
                            document.getElementById('grade-filter').value = state.gradeFilter;
                        }
                        
                        if (state.termFilter) {
                            document.getElementById('term-filter').value = state.termFilter;
                        }
                        
                        // æ¢å¤æœç´¢å…³é”®è¯
                        if (state.searchInput) {
                            document.getElementById('search-input').value = state.searchInput;
                        }
                        
                        // æ¢å¤å½“å‰é¡µç 
                        if (state.currentPage) {
                            currentPage = state.currentPage;
                        }
                        
                        // åº”ç”¨ä¿å­˜çš„çŠ¶æ€
                        filterAudio();
                    } else {
                        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œåˆ™æ˜¾ç¤ºç¬¬ä¸€é¡µ
                        renderPage(currentPage);
                    }
                } catch (e) {
                    console.error('æ¢å¤ç”¨æˆ·çŠ¶æ€å¤±è´¥:', e);
                    // å‡ºé”™æ—¶æ˜¾ç¤ºç¬¬ä¸€é¡µ
                    renderPage(currentPage);
                }
            }
        // ... existing code ...
    </script>

    <footer style="background-color: #f8f9fa; padding: 20px; text-align: center; margin-top: 40px; border-top: 1px solid #e9ecef;">
        <div class="container">
            <p style="color: #6c757d; margin: 0 0 10px 0;">ä¸­å°å­¦è¯­æ–‡ç¤ºèŒƒè¯µè¯»åº“</p>
            <p style="color: #6c757d; margin: 0 0 10px 0; font-size: 0.9em;">è‡´åŠ›äºä¸ºæ•™å¸ˆæä¾›é«˜è´¨é‡çš„è¯­æ–‡è¯¾æ–‡æœ—è¯»èµ„æº</p>
            <p style="color: #6c757d; margin: 0 0 10px 0; font-size: 0.8em;">
                éŸ³é¢‘èµ„æºæ¥æºï¼š<a href="https://edu.cnr.cn/eduzt/ywkwsfsd/" target="_blank">ä¸­å¤®äººæ°‘å¹¿æ’­ç”µå°ä¸­å°å­¦è¯­æ–‡ç¤ºèŒƒè¯µè¯»åº“</a>
            </p>
            <p style="color: #6c757d; margin: 0 0 10px 0; font-size: 0.8em;">
                æœ¬é¡¹ç›®ä»£ç ç”±TRAEç”Ÿæˆï¼Œä»…ç”¨äºæ–¹ä¾¿è§‚çœ‹å­¦ä¹ ï¼Œå¦‚æœ‰ä¾µæƒè¯·è”ç³»åˆ é™¤ã€‚
            </p>
            <p style="color: #6c757d; margin: 0; font-size: 0.8em;">Â© 2025 ä¸­å°å­¦è¯­æ–‡ç¤ºèŒƒè¯µè¯»åº“ - ä¼ æ‰¿ä¸­åæ–‡åŒ–ï¼Œæå‡è¯­è¨€ç´ å…»</p>
        </div>
    </footer>
</body>
</html>